#!/bin/bash

MSG_UNDEFINED=0
MSG_EN[$MSG_UNDEFINED]="Undefined message. Pease report this error."
MSG_DE[$MSG_UNDEFINED]="Unbekannte Meldung. Bitte melde diesen Fehler."
MSG_DOWNLOAD_FAILED=1
MSG_EN[$MSG_DOWNLOAD_FAILED]="WARNING! Failed to download %b!"
MSG_DE[$MSG_DOWNLOAD_FAILED]="WARNUNG! Download von %b fehlgeschlagen!"
MSG_NOT_ROOT=2
MSG_EN[$MSG_NOT_ROOT]="You have to be root!"
MSG_DE[$MSG_NOT_ROOT]="Du musst root sein!"
MSG_README_HINT=3
MSG_EN[$MSG_README_HINT]="Please read the instructions at https://github.com/ajacobsen/block-tracker"
MSG_DE[$MSG_README_HINT]="Bitte lese die Anweisungen unter https://github.com/ajacobsen/block-tracker"
MSG_DISABLED_SUCCESS=4
MSG_EN[$MSG_DISABLED_SUCCESS]="block-tracker is now disabled"
MSG_DE[$MSG_DISABLED_SUCCESS]="block-tracker ist nun ausgeschaltet"
MSG_PROCESSING_URL=5
MSG_EN[$MSG_PROCESSING_URL]="Downloading and processing %b"
MSG_DE[$MSG_PROCESSING_URL]="%b wird runtergeladen und bearbeitet"
MSG_FINISHED_GENERATING=6
MSG_EN[$MSG_FINISHED_GENERATING]="Finished creating %b"
MSG_DE[$MSG_FINISHED_GENERATING]="%b wurde erstellt"

MSGVAR="MSG_$(tr '[:lower:]' '[:upper:]' <<< ${LANG:0:2})"

write_to_console() { #messagenumber parm1 ... parmn
    local msgv
    local msg
    local msgn
    msgn=$1
    if [ -z $1 ]; then
        msgn=0
    fi
    msgv="$MSGVAR[$msgn]"
    msg=${!msgv}
    if [ -z "${msg}" ]; then
      msg="${MSG_EN[$msgn]}"
    fi
    printf "${msg}\n" "${@:2}"
}

if [ $UID -ne 0 ]; then
    write_to_console "${MSG_NOT_ROOT}"
    exit 1
fi

# PrÃ¼fe ob /etc/hosts.d und /etc/hosts.d/00-hosts existieren
if ([ ! -d /etc/hosts.d ] || [ ! -f /etc/hosts.d/00-hosts ]); then
    write_to_console "${MSG_README_HINT}"
    exit 2
fi

if [ $# -gt 0 ] && [ $1 == "--disable" ]; then
    cp /etc/hosts.d/00-hosts /etc/hosts
    write_to_console "${MSG_DISABLED_SUCCESS}"
    exit 0
fi

# Download der hosts Dateien
# Entfernen von carriage returns
# Entfernen von localhost und broadcast Adressen
# Entfernen von allen Kommentaren
# Entfernen aller Zeilen, die nicht mit 0.0.0.0 beginnen
# Entfernen von Leerzeilen
write_to_console "${MSG_PROCESSING_URL}" "http://winhelp2002.mvps.org"
wget -qO - "http://winhelp2002.mvps.org/hosts.txt"| \
    sed -e 's/\r//' -e '/^0/!d' -e 's/#.*$//'> "/etc/hosts.d/10-mvpblocklist" || \
    write_to_console "${MSG_DOWNLOAD_FAILED}" "http://winhelp2002.mvps.org/hosts.txt"

write_to_console "${MSG_PROCESSING_URL}" "http://someonewhocares.org"
wget -qO - "http://someonewhocares.org/hosts/zero/hosts"| \
    sed -e '/^0/!d' -e 's/#.*$//' > "/etc/hosts.d/20-some1whocaresblocklist" || \
    write_to_console "${MSG_DOWNLOAD_FAILED}" "http://someonewhocares.org/hosts/zero/hosts"

write_to_console "${MSG_PROCESSING_URL}" "http://sysctl.org"
wget -qO - "http://sysctl.org/cameleon/hosts"| \
    sed -e '/^127.0.0.1.*localhost$/d' -e 's/^127.0.0.1/0.0.0.0/' -e 's/[\t]//g' -e '/^0/!d' > "/etc/hosts.d/30-sysctlblocklist" || \
    write_to_console "${MSG_DOWNLOAD_FAILED}" "http://sysctl.org/cameleon/hosts"

write_to_console "${MSG_PROCESSING_URL}" "http://pgl.yoyo.org"
wget -qO - "http://pgl.yoyo.org/as/serverlist.php?hostformat=hosts&showintro=0&mimetype=plaintext"| \
    sed -e 's/^127.0.0.1/0.0.0.0/' -e '/^0/!d' > "/etc/hosts.d/40-yoyo.orgblocklist" || \
    write_to_console "${MSG_DOWNLOAD_FAILED}" "http://pgl.yoyo.org/as/serverlist.php?hostformat=hosts&showintro=0&mimetype=plaintext"

# Insert comment
# Concatenate files
# Remove leading and trailing spaces
# Eliminate duplicates
printf "# DO NOT EDIT THIS FILE\\n# It is automaticly generated by block-tracker from the files in /etc/hosts.d/\\n# Your original hosts file can be found at /etc/hosts.d/00-hosts you should make any changes there" > /etc/hosts
cat /etc/hosts.d/* | sed -e 's/^\s\+//g' -e 's/\s\+$//g'| sort -u >> /etc/hosts

write_to_console "${MSG_FINISHED_GENERATING}" "/etc/hosts"
